# ğŸš€ ì†Œì¼“ ì—°ê²°

<br>

## ì„œë²„

### ì„œë²„ ì‹¤í–‰ ìˆœì„œ

1. `socket()` í†µì‹ ì„ í•˜ê¸° ìœ„í•œ íšŒì„ ì„ ìƒì„±
2. `bind()` ì„œë²„ì˜ IP ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ì†Œì¼“ì— ê³ ì •
3. `listen()` ì„œë²„ì— ì ‘ì†í•˜ë ¤ëŠ” í´ë¼ì´ì–¸íŠ¸ë¥¼ í¬ì°©í•˜ê³  ì‘ë‹µì„ ì£¼ê¸° ìœ„í•´ ëŒ€ê¸°
4. `accept()` í´ë¼ì´ì–¸íŠ¸ê°€ connectë¥¼ ìš”ì²­í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ìŠ¹ì¸
5. `read()` í´ë¼ì´ì–¸íŠ¸ê°€ ì „ë‹¬í•œ ë°ì´í„°ë¥¼ ì½ìŒ
6. `write()` í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ì „ë‹¬
7. `close()` ì„œë²„ë¥¼ ì¢…ë£Œ

### ğŸ“ ì„œë²„ ì˜ˆì œ

```c
int main(int argc, char *argv[])
{
	int  nIdx;
	int  nReturnValue;

	unsigned int nClientLen;

	int nServerSockFd = -1;
	int nAcceptSockfd = -1;

	struct sockaddr_in server_addr;
	struct sockaddr_in client_addr;

	int nPortNum = 0;

	pid_t  nChildPid;

	/*** ì…ë ¥íŒŒë¼ë¯¸í„° ì²´í¬ ***/
	if( argc != 2 ){
		printf("Usage : %s [PORT]\n", argv[0]);
		exit(0);
	}

	nPortNum = atoi(argv[1]);
	if( nPortNum <= 0 ){
		printf("INVALID_PORT_NUM nPortNum[%d]\n", nPortNum);
		exit(0);
	}

	/*** ì„œë²„ì†Œì¼“í”„ë¡œê·¸ë¨ BIND LISTEN ***/
	if( (nServerSockFd = socket(AF_INET, SOCK_STREAM, 0)) < 0 ){
		printf("FILE[%.30s:%d]SocketOpenError errno[%d][%s]\n", __FILE__, __LINE__, errno, strerror(errno));
		return -1;
	}

	setsockopt( nServerSockFd, SOL_SOCKET, SO_REUSEADDR, (char *)&nPortNum, sizeof(nPortNum) );

	bzero(&server_addr, sizeof(server_addr));

	server_addr.sin_family      = AF_INET;
	server_addr.sin_addr.s_addr = INADDR_ANY;
	server_addr.sin_port        = htons(nPortNum);

	if( bind(nServerSockFd, (struct sockaddr *)&server_addr, sizeof(server_addr)) < 0 ){
		close(nServerSockFd);

		printf("FILE[%.30s:%d]SocketBindError errno[%d][%s] nPortNum[%d]\n", __FILE__, __LINE__, errno, strerror(errno), nPortNum);
		return -1;
	}

	if(listen(nServerSockFd, SOMAXCONN) < 0) {

		close(nServerSockFd);

		printf("FILE[%.30s:%d]SocketListenError errno[%d][%s]\n", __FILE__, __LINE__, errno, strerror(errno));
		return -1;
	}

	/*** ë°ëª¬í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë§Œë“¤ê¸° ***/
	if( DaemonInit() == -1 ){

		printf("FILE[%.30s:%d]DaemonInit() Fail\n", __FILE__, __LINE__);
		return -1;

	}
	else{

		printf("FILE[%.30s:%d]DaemonInit() OK\n", __FILE__, __LINE__);

	}
	
	/*** ì‹œê·¸ë„ì²˜ë¦¬ ***/
	for(nIdx=1; nIdx<NSIG; nIdx++){
		signal(nIdx, SIG_IGN);
	}

	/*** ë©”ì¸ ë£¨í”„ ë¬¸ ì²˜ë¦¬ ***/
	while(1){

		nClientLen = sizeof(struct sockaddr_in);

		nAcceptSockfd = accept(nServerSockFd, (struct sockaddr *)&client_addr, &nClientLen);

		if( nAcceptSockfd < 0){
			return -1;
		}

		// fork() -> ìì‹ í”„ë¡œì„¸ìŠ¤ë¥¼ í•˜ë‚˜ ìƒì„±
		// í•˜ë‚˜ì˜ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ ì•„ë˜ì—ì„œ ì—¬ëŸ¬ ìì‹ í”„ë¡œì„¸ìŠ¤ê°€ í™œë™ ê°€ëŠ¥
		nChildPid = fork();

		if( nChildPid == 0 ){

			close(nServerSockFd);

			nReturnValue = ReceiveMsgHandler(nAcceptSockfd);

			close(nAcceptSockfd) ;
			exit(0);

		}
		else if( nChildPid > 0 ){

			close(nAcceptSockfd) ;

		}
		else if( nChildPid < 0 ){

			printf("FILE[%.30s:%d]fork ì‹œìŠ¤í…œ í˜¸ì¶œì—ì„œ ì—ëŸ¬ë°œìƒ nChildPid[%d]\n", __FILE__, __LINE__, nChildPid);

			close(nAcceptSockfd);
			return -1;

		}

	}  /*** whileë¬¸ì˜ ë ***/

	close(nServerSockFd);

	return 1;

}  /*** main() ì²˜ë¦¬ ë ***/
```

<br><br><br>

## í´ë¼ì´ì–¸íŠ¸

### í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰ ìˆœì„œ

1. `socket()`
2. `connect()`
3. `read()`
4. `write()`
5. `close()`

### ğŸ“ í´ë¼ì´ì–¸íŠ¸ ì˜ˆì œ

```c
int socketInit(char *host, char *portbuf)
{
    int    ret = -1;
    int    realport;
    int    z;

    struct sockaddr_in name;
    struct hostent *hp;
    struct servent *sp;

    int    sock;

    sock = socket (AF_INET, SOCK_STREAM, 0);
    if( sock < 0 ){
        printf("FILE[%.30s:%d] error on open socket errno : %d\n", __FILE__, __LINE__, errno);
        return ret;
    }

    if( !isdigit(portbuf[0]) ){
        sp = getservbyname( portbuf, "tcp" );
        if( sp == NULL ){
            printf("FILE[%.30s:%d]  getservbyname error !! [%s]\n", __FILE__, __LINE__, portbuf);
            return ret;
        }
        realport = sp->s_port;
    }
    else{
        realport = atol(portbuf);
    }

    if( !isdigit(host[0]) ){

        hp = gethostbyname (host);

        if( hp == NULL ){
            printf("FILE[%.30s:%d]  gethostbyname error !! [%s]\n", __FILE__, __LINE__, host);
            return ret;
        }

        memcpy ( (char *)&name.sin_addr, hp->h_addr_list[0], hp->h_length );
        name.sin_family = hp->h_addrtype;

        printf("FILE[%.30s:%d] socketInit DNS get IP[%.15s] port[%d] connect.....\n", __FILE__, __LINE__, inet_ntoa(name.sin_addr), realport );

    }
    else{

        name.sin_addr.s_addr = inet_addr (host);
        name.sin_family = AF_INET;

    }

    name.sin_port = realport;

    printf("FILE[%.30s:%d] socketInit sock [%d] [%d] [%.15s] port[%d] connect.....\n", __FILE__, __LINE__, sock, name.sin_family, host, name.sin_port );

    if( connect( sock, (struct sockaddr *)&name, sizeof(name) ) < 0 ){

        for ( z = 0; z < 5; z++ ){
            printf ("FILE[%.30s:%d] socket connect error !! HOST [%s] port # [%s] errno[%d]\n", __FILE__, __LINE__, host, portbuf, errno);
            usleep (200000);
        }

        return -1;

    }

    return sock;

}  /*** socketInit() ***/
```
